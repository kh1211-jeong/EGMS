{% extends "base.html" %}

{% block head_extras %}
<style>
  .eqp-intro {
    font-size: 13px;
    color: var(--text-muted);
    text-align: center;
    line-height: 1.7;
    margin-bottom: 16px;
  }

  .eqp-intro b {
    color: #e5e7eb;
  }

  .eqp-toolbar {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    margin-bottom: 10px;
  }

  .btn {
    padding: 6px 14px;
    font-size: 12px;
    border-radius: 999px;
    border: 1px solid rgba(148, 163, 184, 0.5);
    background: rgba(15, 23, 42, 0.9);
    color: #e5e7eb;
    cursor: pointer;
    transition: background 0.15s, box-shadow 0.15s, transform 0.08s;
  }

  .btn:hover {
    background: rgba(30, 64, 175, 0.9);
    box-shadow: 0 0 12px rgba(59, 130, 246, 0.65);
  }

  .btn-primary {
    background: linear-gradient(135deg, #2563eb, #38bdf8);
    border-color: rgba(59, 130, 246, 0.9);
  }

  .btn-primary:hover {
    background: linear-gradient(135deg, #1d4ed8, #0ea5e9);
  }

  .eqp-shell {
    border-radius: 24px;
    border: 1px solid rgba(55, 65, 81, 0.9);
    padding: 20px 22px 16px;
    background: radial-gradient(circle at top, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 1));
  }

  .eqp-table-outer {
    margin-top: 8px;
    border-radius: 18px;
    border: 1px solid rgba(55, 65, 81, 0.9);
    overflow: hidden;
    background: rgba(15, 23, 42, 0.98);
  }

  /* ğŸ”¹ ì—¬ê¸°ì„œ ê³ ì • ë†’ì´ + ë‚´ë¶€ ìŠ¤í¬ë¡¤ */
  .eqp-table-wrapper {
    max-height: 430px;
    overflow-y: auto;
    padding-right: 6px; /* ìŠ¤í¬ë¡¤ë°” ì—¬ë°± */
  }

  .eqp-table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
  }

  .eqp-table thead {
    background: rgba(15, 23, 42, 0.98);
    position: sticky;
    top: 0;
    z-index: 1;
  }

  .eqp-table th,
  .eqp-table td {
    border-bottom: 1px solid rgba(30, 41, 59, 0.9);
    padding: 9px 12px;
    font-size: 12px;
    text-align: left;
    color: #e5e7eb;
  }

  .eqp-table th {
    font-weight: 600;
    color: #93c5fd;
    white-space: nowrap;
  }

  .eqp-table tbody tr:hover {
    background: radial-gradient(circle at left, rgba(37, 99, 235, 0.18), transparent 70%);
  }

  .eqp-cell-input {
    width: 100%;
    border-radius: 6px;
    border: 1px solid rgba(55, 65, 81, 0.9);
    background: rgba(15, 23, 42, 0.9);
    padding: 5px 8px;
    font-size: 12px;
    color: #e5e7eb;
    outline: none;
  }

  .eqp-cell-input:focus {
    border-color: rgba(129, 140, 248, 0.9);
    box-shadow: 0 0 0 1px rgba(129, 140, 248, 0.7);
  }

  .eqp-footnote {
    margin-top: 8px;
    font-size: 11px;
    color: var(--text-soft);
    text-align: left;
  }

  .eqp-status {
    margin-top: 4px;
    font-size: 11px;
    color: #a5b4fc;
    text-align: right;
  }
</style>
{% endblock %}

{% block content %}
  <div class="content-inner">
    <p class="eqp-intro">
      ê° ì„¤ë¹„ë¥¼ <b>EQP_NO / ì´ë¦„ / íƒ€ì… / ê±´ë¬¼ / ìœ„ì¹˜ / ìƒìœ„ ì„¤ë¹„</b> ê¸°ì¤€ìœ¼ë¡œ ì—‘ì…€ì²˜ëŸ¼ ê´€ë¦¬í•˜ê³ ,<br />
      ì´í›„ ì´ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ <b>ì—°ê²° ì •ë³´(Topology)</b>ë¥¼ ìë™ êµ¬ì„±í•  ì˜ˆì •ì…ë‹ˆë‹¤.
    </p>

    <div class="eqp-shell">
      <div class="eqp-toolbar">
        <button class="btn" type="button" id="btn-eqp-import">
          ì—‘ì…€ ê°€ì ¸ì˜¤ê¸°
        </button>
        <button class="btn" type="button" id="btn-eqp-export">
          ì—‘ì…€ ë‚´ë³´ë‚´ê¸°
        </button>
        <button class="btn btn-primary" type="button" id="btn-eqp-save">
          ë³€ê²½ ë‚´ìš© ì €ì¥
        </button>
      </div>

      <div class="eqp-table-outer">
        <div class="eqp-table-wrapper">
          <table class="eqp-table">
            <thead>
              <tr>
                <th style="width: 150px;">EQP_NO</th>
                <th style="width: 230px;">EQP_NAME</th>
                <th style="width: 140px;">TYPE</th>
                <th style="width: 120px;">ê±´ë¬¼</th>
                <th>ìœ„ì¹˜</th>
                <th style="width: 170px;">ìƒìœ„ EQP_NO</th>
              </tr>
            </thead>
            <tbody id="eqp-tbody">
              <!-- JSì—ì„œ ë Œë”ë§ -->
            </tbody>
          </table>
        </div>
      </div>

      <div class="eqp-status" id="eqp-status">
        ì„¤ë¹„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...
      </div>

      <p class="eqp-footnote">
        â€» ì§€ê¸ˆì€ íŒŒì¼ëŸ¿ ë‹¨ê³„ë¼ ì„œë²„ ë©”ëª¨ë¦¬ & JSON íŒŒì¼ ê¸°ì¤€ìœ¼ë¡œë§Œ ë°˜ì˜ë©ë‹ˆë‹¤. (ì •ì‹ DB ì—°ë™ì€ ì´í›„ ë‹¨ê³„ì—ì„œ ì§„í–‰)
      </p>
    </div>

    <!-- ì—‘ì…€ Importìš© ìˆ¨ê²¨ì§„ input -->
    <input type="file" id="eqp-file-input" accept=".csv" style="display:none" />
  </div>
{% endblock %}

{% block scripts %}
<script>
  let eqpItems = [];

  function renderEqpTable() {
    const tbody = document.getElementById("eqp-tbody");
    tbody.innerHTML = "";

    eqpItems.forEach((item, idx) => {
      const tr = document.createElement("tr");

      function makeCell(key, readOnly = false) {
        const td = document.createElement("td");
        const input = document.createElement("input");
        input.className = "eqp-cell-input";
        input.value = item[key] ?? "";
        input.readOnly = readOnly;
        input.dataset.index = idx;
        input.dataset.field = key;
        input.addEventListener("change", (e) => {
          const i = Number(e.target.dataset.index);
          const f = e.target.dataset.field;
          eqpItems[i][f] = e.target.value;
        });
        td.appendChild(input);
        return td;
      }

      tr.appendChild(makeCell("eqp_no", false));        // í•„ìš”í•˜ë©´ trueë¡œ EQP_NO ì ê¸€ ìˆ˜ ìˆìŒ
      tr.appendChild(makeCell("eqp_name", false));
      tr.appendChild(makeCell("type", false));
      tr.appendChild(makeCell("building", false));
      tr.appendChild(makeCell("location", false));
      tr.appendChild(makeCell("parent_eqp_no", false));

      tbody.appendChild(tr);
    });
  }

  async function loadEquipments() {
    const statusEl = document.getElementById("eqp-status");
    statusEl.textContent = "ì„¤ë¹„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...";

    try {
      const res = await fetch("/api/equipments");
      if (!res.ok) {
        statusEl.textContent = "ì„¤ë¹„ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
        return;
      }
      const data = await res.json();
      eqpItems = data.items || [];
      renderEqpTable();
      statusEl.textContent = `ì´ ${eqpItems.length}ê°œ ì„¤ë¹„ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`;
    } catch (err) {
      console.error(err);
      statusEl.textContent = "ì„¤ë¹„ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
    }
  }

  async function saveEquipments() {
    const statusEl = document.getElementById("eqp-status");
    statusEl.textContent = "ë³€ê²½ ë‚´ìš©ì„ ì €ì¥ ì¤‘ì…ë‹ˆë‹¤...";

    try {
      const res = await fetch("/api/equipments", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ items: eqpItems }),
      });
      if (!res.ok) {
        statusEl.textContent = "ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
        return;
      }
      const data = await res.json();
      statusEl.textContent = `ì €ì¥ ì™„ë£Œ Â· ${data.count ?? eqpItems.length}ê°œ ì„¤ë¹„ ë°˜ì˜`;
    } catch (err) {
      console.error(err);
      statusEl.textContent = "ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
    }
  }

  function exportEquipments() {
    // ë‹¨ìˆœíˆ ë§í¬ ì´ë™ìœ¼ë¡œ CSV ë‹¤ìš´ë¡œë“œ
    window.location.href = "/api/equipments/export";
  }

  function openImportDialog() {
    const input = document.getElementById("eqp-file-input");
    input.value = "";
    input.click();
  }

  async function handleImportChange(event) {
    const file = event.target.files[0];
    if (!file) return;

    const statusEl = document.getElementById("eqp-status");
    statusEl.textContent = "ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤...";

    const formData = new FormData();
    formData.append("file", file);

    try {
      const res = await fetch("/api/equipments/import", {
        method: "POST",
        body: formData,
      });

      if (!res.ok) {
        statusEl.textContent = "ì—‘ì…€ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
        return;
      }

      const data = await res.json();
      statusEl.textContent = `ì—‘ì…€ ë°˜ì˜ ì™„ë£Œ Â· ${data.count ?? 0}ê°œ ì„¤ë¹„ ë°˜ì˜`;
      await loadEquipments();   // ìƒˆ ë°ì´í„° ë‹¤ì‹œ ë¡œë“œ
    } catch (err) {
      console.error(err);
      statusEl.textContent = "ì—‘ì…€ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
    }
  }

  document.getElementById("btn-eqp-save").addEventListener("click", saveEquipments);
  document.getElementById("btn-eqp-export").addEventListener("click", exportEquipments);
  document.getElementById("btn-eqp-import").addEventListener("click", openImportDialog);
  document.getElementById("eqp-file-input").addEventListener("change", handleImportChange);

  // í˜ì´ì§€ ì§„ì… ì‹œ ìë™ ë¡œë“œ
  loadEquipments();
</script>
{% endblock %}
